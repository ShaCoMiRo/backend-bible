# 쿠키 기반 인증

1. [HTTP의 특징과 쿠키와 세션을 사용하는 이유](#http의-특징과-쿠키와-세션을-사용하는-이유)
2. [쿠키(Cookie)](#쿠키cookie)
   1. 쿠키란?
   2. 쿠키의 구성 요소
   3. 쿠키의 동작 방식
   4. 쿠키의 사용 예
3. [세션(Session)](#세션session)
   1. 세션이란?
   2. 세션의 동작 방식
   3. 세션의 특징
   4. 세션의 사용 예
4. [쿠키와 세션의 차이](#쿠키와-세션의-차이)
   1. [세션이 보안상 유리함에도 여전히 쿠키를 사용하는 이유](#세션이-보안상-유리함에도-여전히-쿠키를-사용하는-이유)
   2. [쿠키와 세션은 엄연히 다르다](#쿠키와-세션은-엄연히-다르다)
5. [쿠키와 세션을 사용한 인증(Authentication)과 인가(Authorization)](#쿠키와-세션을-사용한-인증authentication과-인가authorization)
6. [참고 자료](#참고-자료)

## HTTP의 특징과 쿠키와 세션을 사용하는 이유

쿠키와 세션은 HTTP 프로토콜의 특징이자 약점인 **비연결성(Connectionless)과 무상태성(Stateless) 때문에 사용**한다.

서버는 HTTP 프로토콜 환경의 특징(비연결성, 비상태성)으로 인해 클라이언트가 요청(Request)을 했을 때 해당 요청에 맞는 응답(Response)를 보내고 연결을 끊은 후 클라이언트에 대한 상태 정보를 유지하지 않는다. 따라서 서버는 클라이언트가 누구인지를 매번 확인해야 한다. 이 특성을 보완하기 위해서 쿠키와 세션을 사용하게 된다.

> **비연결성(Connectionless)**
>
> 클라이언트가 요청을 한 후 응답을 받으면 그 연결을 끊어버리는 특징이다.  
> HTTP는 클라이언트가 먼저 요청(Request)를 서버에 보내면, 서버는 클라이언트에게 요청에 맞는 응답(Response)을 보낸 후 접속을 끊는 특징이 있다. 헤더에 `keep-alive`라는 값을 줘서 커넥션을 재활용하는데, HTTP 1.1에서는 이것이 기본값이다.  
> HTTP가 TCP 위에서 구현되었기 때문에(TCP는 연결지향, UDP는 비연결지향) 네트워크 관점에서 `keep-alive`는 옵션으로 비연결성의 연결 비용을 줄이는 것을 장점으로 비연결지향이라 한다.

> **무상태성(Stateless)**
>
> 통신이 끝나면 상태를 유지하지 않는 특징이다.  
> HTTP는 연결을 끊는 순간 클라이언트와 서버의 통신이 끝나며 상태 정보를 유지하지 않는 특성이 있다. 쿠키와 세션은 위 두 가지 특징을 해결하기 위해 사용한다.
> 예를 들어, 쿠키와 세션을 사용하지 않으면 쇼핑몰에서 옷을 구매하려고 해도 페이지를 이동할 때마다 계속 로그인 과정을 거쳐야 한다. 쿠키와 세션을 사용한다면 한 번 로그인을 거치면 사용자에 대한 인증을 유지할 수 있다.

## 쿠키(Cookie)

### 쿠키란?

- 쿠키는 클라이언트(브라우저) 로컬**에 key-value 쌍으로 저장**되는 데이터 파일이다.
- 사용자 인증이 유효한 시간을 명시할 수 있으며, **유효시간이 정해지면 브라우저가 종료되어도 인증이 유지**된다는 특징이 있다.
- 쿠키는 클라이언트의 상태 정보를 로컬에 저장했다가 참조한다.
- 클라이언트에 300개까지의 쿠키를 저장할 수 있다. 하나의 도메인당 20개의 값만 가질 수 있으며, 하나의 쿠키값은 4KB까지 저장된다.
- 서버에서 Response Header에 **`Set-Cookie` 속성**을 사용하면 클라이언트에 쿠키를 만들 수 있다.
- 쿠키는 **사용자가 따로 작업하지 않아도 브라우저가 요청시에 Request Header에 담아서 서버에 전송**한다.

### 쿠키의 구성 요소

| 구성 요소 | 설명                                    |
| :-------: | --------------------------------------- |
|   이름    | 각각의 쿠키를 구별하는 데 사용되는 이름 |
|    값     | 쿠키의 이름과 관련된 값                 |
| 유효시간  | 쿠키의 유지 시간                        |
|  도메인   | 쿠키를 전송할 도메인                    |
|   경로    | 쿠키를 전송할 요청 경로                 |

### 쿠키의 동작 방식

![velog.io/@lkdfj6-COOKIE](https://velog.velcdn.com/images/lkdfj6/post/badc0287-3fba-4a1f-b3a6-d30354718dba/image.png)

1. 클라이언트가 서버에게 페이지를 **요청**한다.
2. 서버는 **클라이언트에 관한 정보를 토대로 쿠키를 구성**한다.
3. 서버는 클라이언트에게 보내는 HTTP **응답 메시지의 헤더에 쿠키를 담아 응답**한다.
4. 클라이언트가 응답을 받으면, 브라우저는 쿠키를 **쿠키 디렉터리에 저장**한다.
5. 브라우저가 종료되어도 쿠키의 **유효시간이 남아있다면 클라이언트에서 계속 보관**한다.
6. **동일한 요청**을 할 경우 HTTP **요청 메시지 헤더에 쿠키를 함께 담아 요청**한다.
7. 서버에서 쿠키를 읽고, 이전 상태 정보를 변경할 필요가 있을 때 쿠키를 업데이트하고 변경된 쿠키를 HTTP 헤더에 포함시켜 응답한다.

### 쿠키의 사용 예

- 방문 사이트에서 로그인 시, "아이디와 비밀번호를 저장하시겠습니까?"
- 쇼핑몰의 장바구니 기능
- 자동 로그인, 판업에서 "오늘 더 이상 이 창을 보지 않음" 체크 등

## 세션(Session)

### 세션이란?

- 세션은 **쿠키를 기반으로 구현**된다.
  - 그러나 사용자 정보 파일을 브라우저에 저장하는 쿠키와 달리 세션은 **서버 측에서 관리**한다.
- 서버는 각 클라이언트를 구분하기 위해 **세션 ID를 부여**하고, 클라이언트는 **쿠키에 세션 ID를 저장**한다.
  - 클라언트가 요청을 보내면 해당 서버의 엔진이 클라이언트에게 유일한 ID를 부여하는데, 이것이 세션 ID이다.
  - **유효시간**을 두어 일정 시간 응답이 없다면 정보 유지를 멈출 수 있다.
  - 웹 브라우저가 서버에 접속해서 **브라우저를 종료할 때까지 인증 상태를 유지**할 수 있다.
- 사용자 정보를 서버에 두기 때문에 **쿠키보다 보안이 좋다.**
  - 단, 사용자가 많아질수록 더 많은 서버 자원을 차지하기 때문에 **서버에 과부하를 줄 수 있고 성능 저하의 요인이 될 수 있다.**

### 세션의 동작 방식

![velog.io/@lkdfj6-SESSION](https://velog.velcdn.com/images/lkdfj6/post/10a8e30d-6274-46b6-bbf0-08ba5cc7b422/image.png)

1. 클라이언트가 서버에 접속 시 **세션 ID를 발급**받는다.
2. 클라이언트는 발급받은 **세션 ID를 쿠키를 사용하여 저장한 후 보관**한다.
3. 클라이언트는 서버에 요청할 때, **쿠키에 저장된 세션 ID를 요청에 포함해서 서버에 전달**한다.
4. 서버는 세션 ID를 전달받은 후 별다른 작업 없이 **세션 ID로 서버에 있는 클라이언트 정보를 가져와서 사용**한다.
5. 클라이언트 정보를 기반으로 요청을 처리한 후 클라이언트에게 응답한다.

### 세션의 특징

- 각 클라이언트에게 **고유 ID를 부여**한다.
- 세션 ID로 클라이언트를 구분해서 **클라이언트의 요구에 맞는 서비스를 제공**한다.
- **보안 면에서 쿠키보다 우수**하다.
- 사용자가 많아질수록 서버 메모리를 많이 차지한다.

### 세션의 사용 예

- 로그인과 같이 **중요한 보안 작업**을 수행할 때 사용한다.

## 쿠키와 세션의 차이

- 쿠키와 쿠션은 비슷한 역할을 하며, 동작 원리도 비슷하다. 그 이유는 세션도 결국 쿠키를 사용하기 때문이다.
- 가장 큰 차이점은 **사용자의 정보가 저장되는 위치**이다. 때문에 **쿠키는 서버의 자원을 전혀 사용하지 않으며, 세션은 서버의 자원을 사용**한다.
- **보안 면에서 세션이 더 우수**하며, **요청 속도는 쿠키가 세션보다 더 빠르다.** 그 이유는 세션은 서버의 처리가 필요하기 때문이다.

|       구분        | 쿠키                                                                                                                                                                                                          | 세션                                                                                                                                                                                                                                                                                                                                                                                    |
| :---------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|     **보안**      | <ul><li>쿠키는 클라이언트 로컬에 저장되기 때문에 <b>변질되거나 Request에서 스니핑 당할 우려가 있어 보안에 취약</b>하다.</li></ul>                                                                             | <ul><li>세션은 <b>쿠키를 이용해서 세션 ID만 저장</b>하고, 그것으로 구분해서 서버에서 처리하기 때문에 <b>비교적 보안성이 좋다.</b></li><li>하지만 세션 ID만 노출되어 악용되면 서버는 이를 구분할 수 없는데, 이를 <b>세션 하이재킹(Session Hijacking)</b>이라 한다.<ul><li>해결책으로는 <b>HTTPS</b>를 사용하거나 세션에 짧은 주기의 유효시간을 설정하는 방법이 있다.</li></ul></li></ul> |
| **라이프 사이클** | <ul><li>쿠키는 유효시간이 있지만 파일로 저장되기 때문에 <b>브라우저를 종료해도 계속해서 정보가 유지</b>될 수 있다.</li><li>유효시간을 넉넉하게 설정하면 직접 쿠키를 삭제할 때까지 유지될 수도 있다.</li></ul> | <ul><li>세션 역시 유효시간을 정할 수 있지만 <b>브라우저가 종료되면 유효시간에 상관없이 삭제</b>된다. </li><li>동일한 브라우저 내에서는 여러 탭이 세션을 공유할 수 있으며, 다른 브라우저를 사용하면 서로 다른 세션을 사용할 수 있다.</li></ul>                                                                                                                                           |
|     **속도**      | <ul><li>쿠키는 **자체적으로 정보를 보유**하기 때문에 서버에 요청시 속도가 빠르다.</li></ul>                                                                                                                   | <ul><li>세션은 **정보가 서버에 존재**하기 때문에 세션 ID로 정보를 조회하는 추가적인 처리가 요구되어 비교적 느린 속도를 가진다.</li></ul>                                                                                                                                                                                                                                                |
|   **저장 공간**   | <ul><li>쿠키는 정보를 자체적으로 보유하고, **클라이언트에서 보관**하기 때문에 저장 공간의 낭비가 적다.</li></ul>                                                                                              | <ul><li>세션은 **서버 내의 세션 저장소를 사용하여 사용자 데이터를 보관**하기 때문에 추가적인 저장 공간을 필요로 한다.</li></ul>                                                                                                                                                                                                                                                         |

### 세션이 보안상 유리함에도 여전히 쿠키를 사용하는 이유

세션은 서버의 자원을 사용하기 때문에 무분별하게 사용하면 **서버 자원이 부족해지거나 서버 속도가 저하될 수 있다.** 쿠키를 사용하면 서버 자원을 낭비를 방지하여 **웹사이트 속도를 개선**할 수 있다.

### 쿠키/세션은 캐시와 엄연히 다르다

- 캐시는 이미지나 CSS, JS 파일 등을 브라우저나 서버 앞 단에 저장해둔 후 사용하는 것을 말한다.
- 한 번 캐시에 저장되면 브라우저를 참고하기 때문에 서버에서 변경되어도 사용자는 변경된 내용으로 갱신되지 않을 수도 있다.
  - 이 경우 캐시를 지우거나, 서버에서 클라이언트로 응답을 보낼 때 헤더에 캐시 유효시간을 명시하는 방법 등을 사용한다.

## 쿠키와 세션을 사용한 인증(Authentication)과 인가(Authorization)

|         구분         | 설명                                                                                                                 |
| :------------------: | -------------------------------------------------------------------------------------------------------------------- |
| 인증(Authentication) | **사용자가 누구인지 확인**하는 절차를 말한다. 회원가입과 로그인 과정이 인증의 대표적인 예시이다.                     |
| 인가(Authorization)  | 사용자가 요청하는 것에 대한 **권한이 있는지를 확인**하는 절차를 말한다. 마이 페이지 조회가 인가의 대표적인 예시이다. |

세션을 통한 인증, 인가(Auth)의 절차는 다음과 같다.

1. 클라이언트가 로그인을 하면 서버는 회원 정보를 대조하여 <b>인증(Authentication)</b>을 수행한다.
2. 회원(클라이언트) 정보를 **세션 저장소에 생성**하고 **세션 ID를 발급**한다.
3. **HTTP 응답 헤더 쿠키**에 발급한 **세션 ID**를 담아서 보낸다.
4. 클라이언트는 세션 ID를 **쿠키 저장소에 저장**하고 이후에 HTTP **요청을 보낼 때마다 쿠키에 세션 ID를 담아서 보낸다.**
5. 서버에서는 쿠키에 담겨져서 온 세션 ID가 서버에 있다면 <b>인가(Authorization)</b>하여 해당 회원 정보를 세션 저장소에서 가져온다.
6. 응답 메시지에 회원 정보를 바탕으로 처리된 데이터를 담아서 클라이언트에 보낸다.

쿠키와 세션을 이용한 로그인 방식은 로드 밸런싱(Load Balancing), 서버 효율성 관리 및 확장이 어려워질 수 있다는 단점이 있다.

## 참고 자료

- [쿠키와 세션 개념](https://interconnection.tistory.com/74)
- [쿠키와 세션](https://velog.io/@lkdfj6/%EC%BF%A0%ED%82%A4%EC%99%80-%EC%84%B8%EC%85%98%EC%9D%98-%EC%B0%A8%EC%9D%B4%EC%A0%90)
